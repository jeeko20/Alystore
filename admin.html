<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - Boutique √âlectronique</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { padding: 20px; background: #f8f9fa; }
    .produit-admin { background: white; }
    .hero-content { margin-top: 40px; }
  </style>
</head>
<body>

<!-- üîê Protection mot de passe -->
<script>
  const MOT_DE_PASSE = "admin123";
  function demanderMotDePasse() {
    const password = prompt("Entrez le mot de passe pour acc√©der √† l'administration :");
    if (password !== MOT_DE_PASSE) {
      alert("Mot de passe incorrect !");
      window.location.href = "index.html";
    }
  }
  demanderMotDePasse();
</script>

<div class="container">
  <div class="hero-content text-center mb-4">
    <h1>üõ† Admin - Ajouter & Supprimer Produits</h1>
    <a href="index.html" class="btn btn-secondary">‚Üê Retour √† l'accueil</a>
  </div>

  <!-- Formulaire d'ajout -->
  <form id="form-produit" class="mb-5 p-4 bg-white rounded shadow">
    <h3>Ajouter un produit</h3>
    <div class="mb-3">
      <label class="form-label">Nom</label>
      <input type="text" id="nom" class="form-control" required>
    </div>
    <div class="row mb-3">
      <div class="col-md-4">
        <label class="form-label">Cat√©gorie</label>
        <select id="categorie" class="form-select">
          <option value="telephone">T√©l√©phone</option>
          <option value="tablette">Tablette</option>
          <option value="casque">Casque</option>
          <option value="chargeur">Chargeur</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Prix</label>
        <select id="prix" class="form-select">
          <option value="moins-100">Moins de 100$</option>
          <option value="100-300">100$ - 300$</option>
          <option value="plus-300">Plus de 300$</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Image(s)</label>
        <input type="file" id="images" class="form-control" multiple accept="image/*">
      </div>
    </div>
    <div class="mb-3">
      <label class="form-label">Description</label>
      <textarea id="description" class="form-control" rows="3"></textarea>
    </div>
    <button type="submit" class="btn btn-primary">Ajouter le produit</button>
  </form>

  <!-- Liste des produits -->
  <h2>üóë Supprimer un produit</h2>
  <div id="liste-admin-produits"></div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js"></script>
<script>
  const supabase = window.supabase.createClient(
    "https://xswyiwlmxolfbqevqhqu.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhzd3lpd2xteG9sZmJxZXZxaHF1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMDY1MTEsImV4cCI6MjA3MTg4MjUxMX0.scmwfGWUBm9gHVcLDVNzCADYtXsTIAPySxqArZPD0qk"
  );

  // Ajouter un produit
  document.getElementById("form-produit").addEventListener("submit", async (e) => {
    e.preventDefault();

    const nom = document.getElementById("nom").value;
    const categorie = document.getElementById("categorie").value;
    const prix = document.getElementById("prix").value;
    const description = document.getElementById("description").value;
    const fichiers = document.getElementById("images").files;

    if (fichiers.length === 0) {
      alert("Veuillez s√©lectionner au moins une image.");
      return;
    }

    let nomsImages = [];
    for (let i = 0; i < fichiers.length; i++) {
      const file = fichiers[i];
      const filePath = `produits/${Date.now()}_${file.name}`;
      const { data, error } = await supabase.storage.from("produits").upload(filePath, file);
      if (error) {
        alert("Erreur upload: " + error.message);
        return;
      }
      nomsImages.push(data.path); // <-- Stocker le chemin relatif
    }

    const { error } = await supabase.from("produits").insert([
      { nom, categorie, prix, description, images: nomsImages }
    ]);

    if (error) {
      alert("Erreur: " + error.message);
    } else {
      alert("‚úÖ Produit ajout√© !");
      document.getElementById("form-produit").reset();
      chargerProduitsAdmin();
    }
  });

  // Supprimer produit + images
 // ‚úÖ Supprimer produit + images du bucket
async function supprimerProduit(id) {
  if (!confirm("Voulez-vous vraiment supprimer ce produit et ses images ?")) return;

  // üîΩ R√©cup√©rer le produit (et ses images)
  const { data: produit, error: fetchError } = await supabase
    .from("produits")
    .select("images")
    .eq("id", id)
    .single();

  if (fetchError) {
    alert("Erreur lors de la r√©cup√©ration du produit : " + fetchError.message);
    return;
  }

  // üîΩ Supprimer les images du bucket
  if (produit.images && Array.isArray(produit.images) && produit.images.length > 0) {
    const { error: removeError } = await supabase
      .storage
      .from("produits") // ‚ö†Ô∏è Nom du bucket
      .remove(produit.images); // ‚úÖ Tableau de chemins

    if (removeError) {
      console.error("Erreur suppression images:", removeError.message);
      alert("‚ö†Ô∏è Les images n'ont pas pu √™tre supprim√©es : " + removeError.message);
      // On continue quand m√™me vers la suppression de la DB
    }
  }

  // üîΩ Supprimer le produit de la table
  const { error: deleteError } = await supabase
    .from("produits")
    .delete()
    .eq("id", id);

  if (deleteError) {
    alert("Erreur suppression produit: " + deleteError.message);
  } else {
    alert("‚úÖ Produit et images supprim√©s !");
    chargerProduitsAdmin(); // Rafra√Æchir la liste
  }
}

  // Charger les produits existants
  async function chargerProduitsAdmin() {
    const { data: produits, error } = await supabase.from("produits").select("*");
    if (error) {
      console.error("Erreur chargement admin:", error.message);
      return;
    }

    const container = document.getElementById("liste-admin-produits");
    container.innerHTML = produits.length === 0 ? "<p>Aucun produit disponible.</p>" : "";

    produits.forEach(produit => {
      const premierImg = produit.images?.[0];
      let urlImage = "https://via.placeholder.com/50";
      if (premierImg) {
        const { data } = supabase.storage.from("produits").getPublicUrl(premierImg);
        urlImage = data?.publicUrl || urlImage;
      }

      const div = document.createElement("div");
      div.className = "produit-admin mb-2 p-2 border rounded d-flex align-items-center";

      div.innerHTML = `
        <img src="${urlImage}" width="50" height="50" style="object-fit: cover; margin-right: 10px;">
        <span>${produit.nom}</span>
        <button class="btn btn-danger btn-sm ms-auto">Supprimer</button>
      `;

      const btnSupprimer = div.querySelector("button");
      btnSupprimer.addEventListener("click", () => supprimerProduit(produit.id));

      container.appendChild(div);
    });
  }
  
  // Charger au d√©marrage
  chargerProduitsAdmin();
</script>

</body>
</html>
